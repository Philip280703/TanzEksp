@inject TripService tripService
@inject BookingService bookingService
@inject CustomerService customerService
@inject TripEventService tripEventService
@inject DayPlanService dayPlanService
@attribute [Authorize(Roles = "Admin, User")]
@using Microsoft.AspNetCore.Authorization
@using TanzEksp.Shared.DTO
@using TanzEksp.Client.Services
@using Microsoft.AspNetCore.Components.Forms

@page "/TripsOnCertainBooking/{bookingId:guid}"

@if (booking == null || customer == null)
{
	<p>Henter data...</p>
}
else
{
	<h4>Kunde info: @customer.FirstName @customer.LastName</h4>
	<h4>Booking ID: @bookingId</h4>
	<h5>Afrejsedato: @booking.DepartureDate?.ToShortDateString()</h5>
	<h5>Trip ID : @(booking.TripId?.ToString() ?? "Ingen")</h5>

	@if (booking.TripId == null)
	{
		<button class="btn-add" @onclick="ShowAddTripModal">Tilføj rejse til booking</button>
	}
	else
	{
		<button class="btn-add" @onclick="ShowAddTripEventModal">Tilføj TripEvent</button>

		<div class="table">
			<table class="rejse-table">
				<thead>
					<tr>
						<th>Titel</th>
						<th>Pris</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var tripEvent in tripEventsInTrip)
					{
						<tr class="trip-event-row">
							<td>@tripEvent.Title</td>
							<td>@tripEvent.Price</td>
						</tr>

						@if (tripEvent.DayPlans != null && tripEvent.DayPlans.Any())
						{
							<tr>
								<td colspan="2">
									<table class="dayplan-subtable">
										<thead>
											<tr>
												<th>Dagsnummer</th>
												<th>Forplejning</th>
											</tr>
										</thead>
										<tbody>
											@foreach (var dayplan in tripEvent.DayPlans)
											{
												<tr class="dayplan-row">
													<td>@dayplan.Title</td>
													<td>@dayplan.Meals</td>
												</tr>
											}
										</tbody>
									</table>
								</td>
							</tr>
						}
					}
				</tbody>
			</table>
		</div>

	}
}



@if (AddTripModal)
{
	<div class="modal-overlay">
		<div class="modal-content">
			<h3>Tilføj rejse til booking</h3>
			<div>
				<button class="btn-add" @onclick="AddPrivateTrip">Tilføj privat rejse</button>
			</div>
			<div>
				<button class="btn-add" @onclick="AddGroupTrip">Tilføj gruppe rejse</button>
			</div>
		</div>
	</div>
}

@if (AddTripEventModal)
{
	<div class="modal-overlay">
		<div class="modal-content">
			<h3>Tilføj TripEvent</h3>
			<div>
				<label for="Title">Titel:</label>
				<select @bind="selectedTripEventId" class="custom-select">
					@foreach (var tripEvent in tripEventTemplate)
					{
						<option value="@tripEvent.Id">@tripEvent.Title</option>
					}
				</select>
			</div>
			<div>
				<button class="btn-add" @onclick="() => AddTripEventToBooking(bookingId, selectedTripEventId)">Tilføj</button>
			</div>
			<div>
				<button class="btn-remove" @onclick="ShowAddTripEventModal">Luk</button>
			</div>
		</div>
	</div>
}


@code {
	[Parameter]
	public Guid bookingId { get; set; }

	private BookingDTO booking { get; set; }
	private CustomerDTO customer { get; set; }
	private List<TripEventDTO> tripEvents { get; set; }
	private List<DayPlanDTO> dayPlans { get; set; } 
	private TripDTO trip { get; set; } = new TripDTO();
	private TripEventDTO TripEvent { get; set; } 

	private List<TripEventDTO> tripEventsInTrip{ get; set; } = new List<TripEventDTO>();
	private List<TripEventDTO> tripEventTemplate { get; set; } = new List<TripEventDTO>();
	private List<DayPlanDTO> DayPlanInTrip { get; set; } = new List<DayPlanDTO>();

	private int selectedTripEventId;

	private bool AddTripEventModal { get; set; } = false;
	private bool AddTripModal { get; set; } = false;

	protected override async Task OnInitializedAsync()
	{
		booking = await bookingService.GetBookingByIdAsync(bookingId);
		customer = await customerService.GetCustomerByIdAsync(booking.CustomerId);

		tripEvents = await tripEventService.GetAllTripEventsAsync();
		tripEventTemplate = tripEvents.Where(x => x.IsTemplate == true).ToList();

		if (booking.TripId != null)
		{
			tripEventsInTrip = tripEvents.Where(x => x.TripId == booking.TripId).ToList();			
		}

		dayPlans = await dayPlanService.GetAll();
		DayPlanInTrip = dayPlans.Where(x => x.TripEventId == booking.TripId).ToList();
	}

	private void ShowAddTripEventModal()
	{
		AddTripEventModal = !AddTripEventModal;
	}

	private async Task AddTripEventToBooking(Guid bookingId, int tripEventId)
	{
		// Hent template TripEvent
		var templateTE = await tripEventService.GetTripEventByIdAsync(tripEventId);

		// Opret nyt TripEvent baseret på template
		var newTripEvent = new TripEventDTO
			{
				Title = templateTE.Title,
				Description = templateTE.Description,
				Days = templateTE.Days,
				Price = templateTE.Price,
				IsTemplate = false,
				TripId = booking.TripId
			};

		// Gem nyt TripEvent
		await tripEventService.AddTripEventAsync(newTripEvent);

		// Hent det nyligt oprettede TripEvent fra databasen (med korrekt ID)
		var allTripEvents = await tripEventService.GetAllTripEventsAsync();
		var createdTripEvent = allTripEvents
			.Where(x => x.TripId == booking.TripId)
			.OrderByDescending(x => x.Id)
			.FirstOrDefault();

		if (createdTripEvent == null)
			return;

		// Hent DayPlans fra template TripEvent
		var templateDayPlans = (await dayPlanService.GetAll())
			.Where(x => x.TripEventId == tripEventId)
			.ToList();

		// Kopiér og tilføj DayPlans til det nye TripEvent
		foreach (var dayPlan in templateDayPlans)
		{
			var newDayPlan = new DayPlanDTO
				{
					TripEventId = createdTripEvent.Id,
					Title = dayPlan.Title,
					Description = dayPlan.Description,
					Accommodation = dayPlan.Accommodation,
					Meals = dayPlan.Meals
				};

			await dayPlanService.AddDayPlanAsync(newDayPlan);
		}

		// 💡 HENT TRIPEVENTS + DAYPLANS FRA DATABASEN IGEN
		tripEvents = await tripEventService.GetAllTripEventsAsync();
		tripEventsInTrip = tripEvents
			.Where(x => x.TripId == booking.TripId)
			.ToList();

		// DayPlans (igen) til TripEvent (til visning)
		var allDayPlans = await dayPlanService.GetAll();

		foreach (var te in tripEventsInTrip)
		{
			te.DayPlans = allDayPlans.Where(dp => dp.TripEventId == te.Id).ToList();
		}

		ShowAddTripEventModal(); 
		StateHasChanged();       
	}



	private void ShowAddTripModal()
	{
		AddTripModal = !AddTripModal;
	}

	private void AddGroupTrip()
	{
		trip.TripType = "Group";
		AddTripToBooking();
	}

	private void AddPrivateTrip()
	{
		trip.TripType = "Private";
		AddTripToBooking();
	}

	private async Task AddTripToBooking()
	{
		try
		{
			await tripService.AddTripAsync(trip);

			var maxtrip = await tripService.GetAllTripsAsync();
			var xtrip = maxtrip.OrderByDescending(t => t.Id).FirstOrDefault();

			booking.TripId = xtrip.Id;

			await bookingService.UpdateBookingAsync(booking);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error adding trip to booking: {ex.Message}");
		}
		finally
		{
			ShowAddTripModal();
			StateHasChanged();
		}
	}

}
